# Compot

Внутренний веб‑сервис для сборки коммерческих предложений: WYSIWYG‑редактор, генерация PDF и история черновиков.  
Проект живёт локально и не требует базы данных — все данные хранятся в JSON на сервере.

## Быстрый старт

```bash
npm install
npm run dev
```

Открыть: `http://localhost:3000`

## Важные команды

- `npm run dev` — запуск приложения. Перед стартом выполняется ежедневная синхронизация кейсов и услуг.
- `npm run sync:cases` — принудительное обновление кейсов и превьюшек.
- `npm run sync:services` — принудительное обновление списка услуг.

## Где лежат данные

- Кейсы: `data/cases/` (каждый кейс — отдельная папка + `case.json`)
- Индекс кейсов: `data/cases/index.json`
- Услуги: `data/services/` и `data/services/index.json`
- Черновики/версии КП: отдельный data‑repo, путь задаётся в `config.json`
- Превью кейсов (локально): `public/case-previews/`
- Сырые данные синхронизации: `data/links/cases-raw.json`
- Статус последней синхронизации: `data/links/case-sync.json`
- Статус последней синхронизации услуг: `data/services/sync.json`

## Data‑repo (предложения и версии)

Предложения живут в отдельном репозитории данных. Это позволяет обновлять код и данные независимо.

`config.json` в корне проекта:
```json
{
  "dataRepo": {
    "path": "/Users/<user>/compot-data",
    "remote": "git@github.com:sobakapav/compot-data.git",
    "branch": "users/<login>",
    "autoPushMinutes": 60
  }
}
```

Поведение:
- Авто‑push работает раз в час, пока запущен сервер.
- Ручной push: кнопка «Сохранить все в облаке» на `/all`.
- При остановке через `stop.sh` выполняется принудительный `commit/push`.

Важно:
- Папка `data/proposals` в репозитории кода больше не используется.
- Если data‑repo не настроен, используется путь по умолчанию `~/compot-data`.

## Синхронизация кейсов

Источник: `https://sobakapav.ru/listPortfolio.json`

Скрипт:
- тянет данные раз в сутки при `npm run dev`;
- обновляет `case.json` и `index.json`;
- скачивает новые превью в `public/case-previews/`.

## Синхронизация услуг

Источник: `https://sobakapav.ru/listServices.json`

Скрипт:
- тянет данные раз в сутки при первом обращении к `/api/services` (и перед `npm run dev`/`npm start`);
- обновляет `data/services/*/service.json` и `data/services/index.json`;
- фиксирует отсутствующие услуги и поля в `data/services/sync.json`.

Ручной запуск:
- `npm run sync:services`
- `POST /api/services/sync`

## Костыли из‑за качества входных данных

- **Нет отдельного JSON с корректными ID услуг.**  
  Сейчас услуги в кейсах приходят строками (названия), поэтому мы вынуждены нормализовать их в ID (алиасы + ключевые слова).  
  **Желательное решение:** источник должен отдавать услуги с их кодами/ID, а не только названия.

- **JSON кейсов приходит как HTML‑страница.**  
  Мы выдёргиваем JSON из `<p>` или из HTML‑текста и декодируем `&quot;` и прочие сущности.  
  **Желательное решение:** отдавать чистый JSON с корректным `Content-Type: application/json`.

- **Превью кейсов приходят разнородными ссылками.**  
  Скрипт скачивает то, что пришло в `image`, и определяет расширение по URL или `content-type`.  
  **Желательное решение:** фиксированный формат превью (например, всегда `.webp`) и явное поле `previewImageUrl`.

## Примечания по PDF

PDF рендерится из отдельной серверной страницы `/print` через Playwright.  
Если появятся расхождения в переносах строк между HTML и PDF — скорее всего причина в различиях рендеринга шрифтов в среде браузера и Chromium.
